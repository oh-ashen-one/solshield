import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL653: Step Finance Treasury Exploit Pattern
 * 
 * Based on the January 2025 Step Finance hack ($40M loss)
 * Executive/treasury wallet compromise through privilege escalation
 * 
 * Attack vector: Attacker gained control of treasury wallet through
 * inadequate access controls and missing multi-signature requirements
 * 
 * References:
 * - CryptoRank: Step Finance $40M breach (Jan 31, 2025)
 * - The Block: Step Finance treasury wallet compromise
 */

export function checkStepFinanceExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const content = input.rust?.content || '';
  const path = input.path;

  // Pattern 1: Treasury wallet without multisig
  const treasuryPatterns = [
    /treasury\s*[=:]\s*ctx\.accounts\.\w+/gi,
    /vault_authority\s*:\s*Signer/gi,
    /treasury_authority\s*:\s*Signer/gi,
    /admin_treasury/gi,
  ];

  for (const pattern of treasuryPatterns) {
    const matches = content.match(pattern);
    if (matches) {
      // Check if there's multisig protection
      const hasMultisig = /multisig|multi_sig|threshold|m_of_n|squads/i.test(content);
      const hasTimelock = /timelock|time_lock|delay|pending/i.test(content);
      
      if (!hasMultisig && !hasTimelock) {
        findings.push({
          id: 'SOL653',
          severity: 'critical',
          title: 'Treasury Wallet Without Multisig Protection (Step Finance Pattern)',
          description: `Treasury/vault authority pattern found without multisig or timelock protection. The Step Finance exploit ($40M) demonstrated how single-signer treasury wallets can be catastrophic targets.`,
          location: path,
          snippet: matches[0],
          recommendation: 'Implement multi-signature requirements for treasury operations using Squads or similar. Add timelocks for large withdrawals. Consider cold storage for reserves.',
        });
      }
    }
  }

  // Pattern 2: Executive privilege without separation of duties
  const execPrivilegePatterns = [
    /admin\s*:\s*Signer.*treasury/gis,
    /authority.*withdraw.*all/gi,
    /owner.*drain/gi,
    /executive.*transfer/gi,
  ];

  for (const pattern of execPrivilegePatterns) {
    if (pattern.test(content)) {
      findings.push({
        id: 'SOL653-2',
        severity: 'high',
        title: 'Executive Privilege Without Separation of Duties',
        description: `Single authority can perform critical treasury operations. This mirrors the Step Finance vulnerability where executive-level access led to complete treasury compromise.`,
        location: path,
        recommendation: 'Implement separation of duties: different authorities for proposing, approving, and executing treasury operations. Require multiple signers for withdrawals above threshold.',
      });
    }
  }

  // Pattern 3: Missing withdrawal limits
  if (/withdraw|transfer_out|drain|send_lamports/i.test(content)) {
    const hasLimits = /max_withdraw|withdrawal_limit|daily_limit|amount\s*[<>]=?\s*\d+/i.test(content);
    const hasRateLimiting = /rate_limit|cooldown|last_withdraw/i.test(content);
    
    if (!hasLimits && !hasRateLimiting) {
      findings.push({
        id: 'SOL653-3',
        severity: 'high',
        title: 'Treasury Operations Without Withdrawal Limits',
        description: `No withdrawal limits or rate limiting detected for fund operations. Attackers can drain entire treasury in single transaction.`,
        location: path,
        recommendation: 'Implement daily/transaction withdrawal limits. Add cooldown periods between large withdrawals. Consider graduated limits based on amount.',
      });
    }
  }

  // Pattern 4: Hot wallet over-concentration
  const hotWalletPatterns = [
    /hot_wallet|operating_wallet|liquid_reserve/gi,
  ];

  for (const pattern of hotWalletPatterns) {
    if (pattern.test(content)) {
      const hasColdStorage = /cold_storage|cold_wallet|reserve_vault|offline/i.test(content);
      
      if (!hasColdStorage) {
        findings.push({
          id: 'SOL653-4',
          severity: 'medium',
          title: 'No Cold Storage Separation',
          description: `Hot wallet operations detected without cold storage separation. Treasury should maintain majority of funds in cold storage.`,
          location: path,
          recommendation: 'Implement cold/hot wallet architecture. Keep only operational funds in hot wallet. Use timelock for cold wallet access.',
        });
      }
    }
  }

  // Pattern 5: Missing treasury monitoring/alerting hooks
  if (/treasury|vault|reserve/i.test(content)) {
    const hasEventLogging = /emit!|msg!.*treasury|log_.*withdraw/i.test(content);
    
    if (!hasEventLogging) {
      findings.push({
        id: 'SOL653-5',
        severity: 'medium',
        title: 'Missing Treasury Operation Logging',
        description: `Treasury operations without comprehensive event logging. Critical for detecting and responding to unauthorized access.`,
        location: path,
        recommendation: 'Emit events for all treasury operations with amount, authority, and timestamp. Integrate with monitoring systems.',
      });
    }
  }

  return findings;
}
