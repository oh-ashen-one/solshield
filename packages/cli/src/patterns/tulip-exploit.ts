import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL204: Vault Strategy Manipulation
 * 
 * Detects vulnerabilities in yield vault strategy implementations.
 * 
 * Real-world exploit: Tulip Protocol - vault strategy manipulation.
 */
export function checkTulipExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, idl, path } = input;

  if (idl) {
    const vaultInstructions = idl.instructions.filter(ix =>
      ix.name.toLowerCase().includes('vault') ||
      ix.name.toLowerCase().includes('strategy') ||
      ix.name.toLowerCase().includes('harvest') ||
      ix.name.toLowerCase().includes('compound')
    );

    for (const ix of vaultInstructions) {
      if (ix.name.toLowerCase().includes('set_strategy') ||
          ix.name.toLowerCase().includes('update_strategy')) {
        findings.push({
          id: 'SOL204',
          severity: 'high',
          title: 'Strategy Update Function',
          description: `Instruction "${ix.name}" can change vault strategy - ensure proper access control.`,
          location: { file: path, line: 1 },
          recommendation: 'Add timelock and multi-sig for strategy changes. Implement strategy whitelisting.',
        });
      }
    }
  }

  if (!rust) return findings;

  const patterns = [
    { pattern: /strategy.*change/i, desc: 'Strategy change' },
    { pattern: /vault.*migrate/i, desc: 'Vault migration' },
    { pattern: /yield.*redirect/i, desc: 'Yield redirection' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of patterns) {
      if (pattern.test(line)) {
        findings.push({
          id: 'SOL204',
          severity: 'high',
          title: 'Vault Strategy Vulnerability',
          description: `${desc} - could redirect user funds to malicious destinations.`,
          location: { file: path, line: i + 1 },
          recommendation: 'Whitelist approved strategies. Add timelock for strategy changes.',
        });
      }
    }
  }

  return findings;
}
