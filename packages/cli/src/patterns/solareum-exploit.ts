import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL202: Rug Pull Prevention
 * 
 * Detects patterns that could enable rug pulls by project teams.
 * 
 * Real-world exploit: Solareum - rug pull led to user fund losses.
 */
export function checkSolareumExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, idl, path } = input;

  if (idl) {
    // Check for dangerous admin functions
    const dangerousFunctions = idl.instructions.filter(ix =>
      ix.name.toLowerCase().includes('drain') ||
      ix.name.toLowerCase().includes('withdraw_all') ||
      ix.name.toLowerCase().includes('migrate') ||
      ix.name.toLowerCase().includes('emergency_exit')
    );

    for (const ix of dangerousFunctions) {
      const hasTimelock = ix.accounts?.some(acc =>
        acc.name.toLowerCase().includes('timelock')
      );

      if (!hasTimelock) {
        findings.push({
          id: 'SOL202',
          severity: 'critical',
          title: 'Potential Rug Pull Vector',
          description: `Instruction "${ix.name}" could allow team to drain funds without timelock.`,
          location: { file: path, line: 1 },
          recommendation: 'Add timelock and governance voting for any fund withdrawal functions.',
        });
      }
    }
  }

  if (!rust) return findings;

  const rugPatterns = [
    { pattern: /drain.*all/i, desc: 'Drain all funds' },
    { pattern: /withdraw.*treasury/i, desc: 'Treasury withdrawal' },
    { pattern: /migrate.*funds/i, desc: 'Fund migration' },
    { pattern: /owner.*withdraw/i, desc: 'Owner withdrawal' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of rugPatterns) {
      if (pattern.test(line)) {
        findings.push({
          id: 'SOL202',
          severity: 'critical',
          title: 'Rug Pull Risk',
          description: `${desc} - could be used to rug pull users.`,
          location: { file: path, line: i + 1 },
          recommendation: 'Implement timelock, multi-sig, and governance for all fund movements.',
        });
      }
    }
  }

  return findings;
}
