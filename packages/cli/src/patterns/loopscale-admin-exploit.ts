import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL655: Loopscale Admin Wallet Exploit Pattern
 * 
 * Based on April 2025 Loopscale exploit ($5.8M loss)
 * Attacker gained control of administrator wallet within 2 weeks of launch
 * 
 * Key vulnerabilities:
 * 1. Admin wallet with excessive privileges
 * 2. Insufficient key management post-launch
 * 3. Missing admin action monitoring
 * 
 * References:
 * - The Block: Loopscale $5.8M exploit (April 26, 2025)
 * - Helius: Solana Hacks History
 */

export function checkLoopscaleAdminExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const content = input.rust?.content || '';
  const path = input.path;

  // Pattern 1: Admin with too many privileges
  const godModePatterns = [
    /admin.*can.*withdraw|admin.*transfer.*any/gi,
    /owner.*full.*access/gi,
    /authority.*all.*operations/gi,
    /super_admin|god_mode|root_access/gi,
  ];

  for (const pattern of godModePatterns) {
    if (pattern.test(content)) {
      findings.push({
        id: 'SOL655',
        severity: 'critical',
        title: 'Admin Account with Excessive Privileges (Loopscale Pattern)',
        description: `Admin/owner account with excessive privileges detected. The Loopscale exploit ($5.8M) demonstrated how compromised admin wallets with god-mode access lead to complete fund loss. Admin privileges should be minimal and specific.`,
        location: path,
        recommendation: 'Implement principle of least privilege. Separate admin roles (config admin, pause admin, upgrade admin). No single key should have complete control.',
      });
    }
  }

  // Pattern 2: Admin can pause AND withdraw (dangerous combo)
  const pauseWithdrawCombo = /pause.*withdraw|emergency.*admin.*transfer/gi.test(content);
  
  if (pauseWithdrawCombo) {
    findings.push({
      id: 'SOL655-2',
      severity: 'critical',
      title: 'Admin Can Pause AND Withdraw (Dangerous Combination)',
      description: `Same admin can both pause protocol and withdraw funds. This enables "pause → drain → disappear" attack pattern.`,
      location: path,
      recommendation: 'Separate pause authority from withdrawal authority. Use multisig with different signers for each function.',
    });
  }

  // Pattern 3: Missing admin action timelock
  const adminActions = [
    /admin.*set_.*rate/gi,
    /admin.*update.*config/gi,
    /admin.*withdraw/gi,
    /admin.*transfer/gi,
  ];

  for (const pattern of adminActions) {
    if (pattern.test(content)) {
      const hasTimelock = /timelock|pending_admin|delay_until|execute_after/i.test(content);
      
      if (!hasTimelock) {
        findings.push({
          id: 'SOL655-3',
          severity: 'high',
          title: 'Admin Actions Without Timelock',
          description: `Admin can execute critical actions immediately without timelock. Users have no time to react to malicious admin behavior.`,
          location: path,
          recommendation: 'Add 24-48 hour timelock for admin config changes. Implement 2-step process: propose → wait → execute.',
        });
      }
    }
  }

  // Pattern 4: Single admin key (no redundancy/backup)
  if (/admin\s*:\s*Signer|authority\s*:\s*Signer/i.test(content)) {
    const hasBackup = /backup_admin|secondary_authority|recovery/i.test(content);
    const hasMultisig = /multisig|threshold|m_of_n/i.test(content);
    
    if (!hasBackup && !hasMultisig) {
      findings.push({
        id: 'SOL655-4',
        severity: 'high',
        title: 'Single Admin Key Without Backup or Multisig',
        description: `Protocol relies on single admin key. Key loss = permanent lockout. Key compromise = complete takeover (as in Loopscale).`,
        location: path,
        recommendation: 'Use multisig (2-of-3 minimum) for admin operations. Implement backup authority with timelock. Consider Squads for governance.',
      });
    }
  }

  // Pattern 5: Admin set at initialization without change mechanism
  if (/init.*admin|initialize.*authority/i.test(content)) {
    const canChangeAdmin = /set_admin|update_authority|transfer_admin/i.test(content);
    
    if (!canChangeAdmin) {
      findings.push({
        id: 'SOL655-5',
        severity: 'medium',
        title: 'Admin Cannot Be Changed After Initialization',
        description: `Admin is set at init but cannot be changed. If admin key is compromised (like Loopscale), there's no recovery path.`,
        location: path,
        recommendation: 'Implement secure admin transfer mechanism with timelock and previous admin confirmation.',
      });
    }
  }

  // Pattern 6: Recently launched protocol (first 30 days are highest risk)
  // This is a heuristic check - look for patterns suggesting new deployment
  const newProtocolPatterns = [
    /version\s*[=:]\s*["']?0\./gi,
    /beta|alpha|testnet.*mainnet/gi,
    /initial_launch|first_deploy/gi,
  ];

  for (const pattern of newProtocolPatterns) {
    if (pattern.test(content)) {
      findings.push({
        id: 'SOL655-6',
        severity: 'info',
        title: 'New Protocol Deployment Risk',
        description: `Indicators of new/beta deployment detected. Loopscale was exploited within 2 weeks of launch. New protocols face heightened key management risks.`,
        location: path,
        recommendation: 'Extra vigilance for admin key security post-launch. Consider graduated rollout with limited TVL caps initially.',
      });
    }
  }

  // Pattern 7: Admin can modify pool/market parameters
  if (/admin.*set_fee|admin.*set_rate|admin.*modify_pool/i.test(content)) {
    const hasBounds = /min_.*max_|bounds|require.*[<>]/i.test(content);
    
    if (!hasBounds) {
      findings.push({
        id: 'SOL655-7',
        severity: 'high',
        title: 'Unbounded Admin Parameter Changes',
        description: `Admin can set pool/market parameters without bounds. Malicious admin could set fees to 100% or rates to extreme values.`,
        location: path,
        recommendation: 'Enforce reasonable bounds on all admin-configurable parameters. Use governance for parameter changes beyond bounds.',
      });
    }
  }

  return findings;
}
