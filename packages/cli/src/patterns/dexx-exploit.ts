import type { Finding } from '../commands/audit.js';
import type { ParsedIdl } from '../parsers/idl.js';
import type { ParsedRust } from '../parsers/rust.js';

/**
 * SOL244: DEXX-style Private Key Leak
 * Detects centralized custody and key management vulnerabilities
 * Reference: DEXX exploit (2024) - $30M stolen due to centralized key management leak
 */
export function checkDexxExploit(idl: ParsedIdl | null, rust: ParsedRust | null): Finding[] {
  const findings: Finding[] = [];

  if (rust) {
    for (const fn of rust.functions) {
      const content = fn.body.toLowerCase();

      // Check for centralized custody patterns
      if (content.includes('custody') || content.includes('custodian') || content.includes('hot_wallet')) {
        if (!content.includes('multisig') && !content.includes('threshold')) {
          findings.push({
            id: 'SOL244',
            severity: 'critical',
            title: 'Centralized Custody Without Multi-sig',
            description: 'Centralized custody detected without multi-sig. DEXX lost $30M due to single key compromise.',
            location: `Function: ${fn.name}`,
            recommendation: 'Use multi-sig (at minimum 2/3) for all custody wallets. Consider MPC solutions.',
          });
        }

        // Check for cold/hot wallet separation
        if (!content.includes('cold_wallet') && !content.includes('hot_limit')) {
          findings.push({
            id: 'SOL244',
            severity: 'high',
            title: 'No Hot Wallet Limits',
            description: 'Custody without hot/cold separation or limits. Hot wallet compromise can drain all funds.',
            location: `Function: ${fn.name}`,
            recommendation: 'Keep majority of funds in cold storage. Set strict withdrawal limits on hot wallets.',
          });
        }
      }

      // Check for key export/generation
      if (content.includes('generate_keypair') || content.includes('new_keypair') || 
          content.includes('from_seed')) {
        if (!content.includes('hsm') && !content.includes('secure_element') && 
            !content.includes('hardware')) {
          findings.push({
            id: 'SOL244',
            severity: 'high',
            title: 'Software Key Generation',
            description: 'Keys generated in software without hardware security. Vulnerable to extraction.',
            location: `Function: ${fn.name}`,
            recommendation: 'Generate custody keys in HSMs. Never export private keys from secure hardware.',
          });
        }
      }

      // Check for centralized server holding keys
      if ((content.includes('server') || content.includes('backend') || content.includes('api')) &&
          (content.includes('keypair') || content.includes('private_key') || content.includes('sign'))) {
        findings.push({
          id: 'SOL244',
          severity: 'critical',
          title: 'Server-Side Key Management',
          description: 'Server appears to hold signing keys. Server compromise leads to total fund loss.',
          location: `Function: ${fn.name}`,
          recommendation: 'Never hold user keys server-side. Use client-side signing or MPC protocols.',
        });
      }

      // Check for key backup patterns
      if (content.includes('backup') || content.includes('recovery') || content.includes('restore')) {
        if (content.includes('key') || content.includes('seed') || content.includes('mnemonic')) {
          if (!content.includes('encrypt') && !content.includes('shamir')) {
            findings.push({
              id: 'SOL244',
              severity: 'high',
              title: 'Unprotected Key Backup',
              description: 'Key backup without encryption or secret sharing. Backup theft means fund theft.',
              location: `Function: ${fn.name}`,
              recommendation: 'Encrypt backups with separate key. Consider Shamir secret sharing for recovery.',
            });
          }
        }
      }

      // Check for mass withdrawal functionality
      if (content.includes('batch_withdraw') || content.includes('mass_transfer') || 
          content.includes('sweep')) {
        if (!content.includes('delay') && !content.includes('rate_limit') && !content.includes('threshold')) {
          findings.push({
            id: 'SOL244',
            severity: 'critical',
            title: 'Mass Withdrawal Without Safeguards',
            description: 'Mass withdrawal functionality without limits. Attacker could sweep all funds quickly.',
            location: `Function: ${fn.name}`,
            recommendation: 'Implement withdrawal delays, rate limits, and anomaly detection. Require multi-sig for large amounts.',
          });
        }
      }

      // Check for key rotation patterns
      if (content.includes('rotate') || content.includes('new_key')) {
        if (!content.includes('old_key') && !content.includes('transition')) {
          findings.push({
            id: 'SOL244',
            severity: 'medium',
            title: 'Key Rotation Without Transition Period',
            description: 'Key rotation may not have proper transition. Could lock funds or create vulnerability window.',
            location: `Function: ${fn.name}`,
            recommendation: 'Implement key rotation with overlap period where both keys are valid temporarily.',
          });
        }
      }

      // Check for decentralized alternative awareness
      if (content.includes('withdraw') && content.includes('user')) {
        if (!content.includes('self_custody') && !content.includes('external_wallet')) {
          findings.push({
            id: 'SOL244',
            severity: 'info',
            title: 'Consider Self-Custody Option',
            description: 'Centralized withdrawal detected. Consider offering users self-custody option.',
            location: `Function: ${fn.name}`,
            recommendation: 'Allow users to withdraw to their own wallets. Promote self-custody education.',
          });
        }
      }

      // Check for key access logging
      if (content.includes('sign') && content.includes('keypair')) {
        if (!content.includes('log') && !content.includes('audit') && !content.includes('monitor')) {
          findings.push({
            id: 'SOL244',
            severity: 'medium',
            title: 'Signing Without Audit Trail',
            description: 'Signing operations lack audit logging. Cannot detect or investigate key misuse.',
            location: `Function: ${fn.name}`,
            recommendation: 'Log all signing operations with timestamps, amounts, and destinations. Set up anomaly alerts.',
          });
        }
      }

      // Check for insurance fund
      if (content.includes('custody') || content.includes('exchange')) {
        if (!content.includes('insurance') && !content.includes('reserve')) {
          findings.push({
            id: 'SOL244',
            severity: 'medium',
            title: 'No Insurance/Reserve Fund',
            description: 'Custodial service without insurance fund. Users have no protection against hacks.',
            location: `Function: ${fn.name}`,
            recommendation: 'Maintain insurance fund proportional to custody amount. Consider third-party insurance.',
          });
        }
      }
    }
  }

  if (idl) {
    // Check for custody-related instructions
    for (const instruction of idl.instructions) {
      const name = instruction.name.toLowerCase();
      
      // Check for admin-only dangerous operations
      if (name.includes('admin') && (name.includes('withdraw') || name.includes('transfer'))) {
        const hasTimelock = instruction.accounts.some(acc => 
          acc.name.toLowerCase().includes('timelock') ||
          acc.name.toLowerCase().includes('delay')
        );

        if (!hasTimelock) {
          findings.push({
            id: 'SOL244',
            severity: 'high',
            title: 'Admin Withdrawal Without Timelock',
            description: `${instruction.name} allows instant admin withdrawal. Compromised admin key = total loss.`,
            location: `Instruction: ${instruction.name}`,
            recommendation: 'Add mandatory timelock for admin withdrawals. Alert users of pending withdrawals.',
          });
        }
      }
    }
  }

  return findings;
}
