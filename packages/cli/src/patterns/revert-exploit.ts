import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL306: Reverting Transaction Exploit
 * Detects vulnerabilities related to transaction reversion abuse
 * Real-world: Cope Roulette exploit (Arrowana)
 */
export function checkRevertExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];

  if (input.rust?.content) {
    const content = input.rust.content;
    const lines = content.split('\n');

    // Detect gambling/randomness patterns
    const hasRandomness = /random|rng|seed|entropy|slot|hash|dice|roulette|lottery|flip/i.test(content);
    const hasGambling = /bet|wager|payout|jackpot|win|lose|gamble/i.test(content);

    if (hasRandomness || hasGambling) {
      // Check for revert-able randomness
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Using slot hash as randomness
        if (line.includes('slot') && (line.includes('hash') || line.includes('random'))) {
          findings.push({
            id: 'SOL306',
            title: 'Slot-Based Randomness Abuse',
            severity: 'critical',
            description: 'Slot hash randomness can be exploited by reverting unfavorable transactions.',
            location: { file: input.path, line: i + 1 },
            suggestion: 'Use commit-reveal scheme or VRF: user commits hash, waits N slots, then reveals',
            cwe: 'CWE-330',
          });
        }

        // Single-transaction randomness
        if (line.includes('random') && !content.includes('commit') && !content.includes('reveal')) {
          if (hasGambling) {
            findings.push({
              id: 'SOL306',
              title: 'Single-TX Randomness Gambling',
              severity: 'critical',
              description: 'Gambling with same-transaction randomness allows reverting losing bets.',
              location: { file: input.path, line: i + 1 },
              suggestion: 'Use commit-reveal: commit_bet() -> wait N slots -> reveal_and_resolve()',
              cwe: 'CWE-330',
            });
            break;
          }
        }
      }

      // Check for outcome-dependent state
      if (content.includes('if') && (content.includes('win') || content.includes('payout'))) {
        if (!content.includes('commit') && !content.includes('lock')) {
          findings.push({
            id: 'SOL306',
            title: 'Unprotected Outcome State',
            severity: 'high',
            description: 'Outcome-dependent payouts without commitment allow selective transaction dropping.',
            location: { file: input.path, line: 1 },
            suggestion: 'Lock bet before resolution: bet.status = BetStatus::Locked; then resolve in separate tx',
            cwe: 'CWE-362',
          });
        }
      }
    }

    // Check for arbitrary external calls with revert
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // CPI that might revert
      if (line.includes('invoke') && !line.includes('invoke_signed')) {
        const contextLines = lines.slice(i, Math.min(i + 10, lines.length)).join('\n');
        if (!contextLines.includes('unwrap_or') && !contextLines.includes('ok()')) {
          if (content.includes('transfer') || content.includes('payout')) {
            findings.push({
              id: 'SOL306',
              title: 'Revertable CPI with State Change',
              severity: 'high',
              description: 'External call failure can revert state changes, enabling selective execution.',
              location: { file: input.path, line: i + 1 },
              suggestion: 'Handle CPI failure gracefully or use pull-payment pattern',
              cwe: 'CWE-754',
            });
            break;
          }
        }
      }
    }

    // Check for NFT reveal patterns
    if (content.includes('reveal') && content.includes('nft')) {
      if (!content.includes('commit') || !content.includes('delay')) {
        findings.push({
          id: 'SOL306',
          title: 'Instant NFT Reveal',
          severity: 'high',
          description: 'Instant NFT reveals can be gamed by reverting if rare trait not received.',
          location: { file: input.path, line: 1 },
          suggestion: 'Use delayed reveal: mint -> wait N blocks -> reveal (separate transactions)',
          cwe: 'CWE-330',
        });
      }
    }

    // Check for auction sniping via revert
    if (content.includes('auction') || content.includes('bid')) {
      if (!content.includes('minimum_increment') && !content.includes('extension')) {
        findings.push({
          id: 'SOL306',
          title: 'Auction Revert Sniping',
          severity: 'medium',
          description: 'Auctions without extensions allow last-second bid revert attacks.',
          location: { file: input.path, line: 1 },
          suggestion: 'Add anti-snipe: if bid in last 5 minutes, extend auction by 5 minutes',
          cwe: 'CWE-362',
        });
      }
    }
  }

  return findings;
}
