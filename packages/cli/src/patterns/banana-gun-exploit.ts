import type { Finding } from '../commands/audit.js';
import type { ParsedIdl } from '../parsers/idl.js';
import type { ParsedRust } from '../parsers/rust.js';

/**
 * SOL243: Banana Gun-style Trading Bot Exploit
 * Detects vulnerabilities in automated trading bots and sniper contracts
 * Reference: Banana Gun exploit (2024) - $1.4M stolen from trading bot users
 */
export function checkBananaGunExploit(idl: ParsedIdl | null, rust: ParsedRust | null): Finding[] {
  const findings: Finding[] = [];

  if (rust) {
    for (const fn of rust.functions) {
      const content = fn.body.toLowerCase();

      // Check for automated trading patterns
      if (content.includes('snipe') || content.includes('auto_buy') || content.includes('bot')) {
        // Check for missing access controls
        if (!content.includes('signer') && !content.includes('authority') && !content.includes('owner')) {
          findings.push({
            id: 'SOL243',
            severity: 'critical',
            title: 'Automated Trade Without Authorization',
            description: 'Automated trading function lacks access control. Anyone could trigger trades on behalf of users.',
            location: `Function: ${fn.name}`,
            recommendation: 'Require user signature or pre-authorized bot signature for all trades.',
          });
        }

        // Check for approval handling
        if (content.includes('approve') || content.includes('delegate')) {
          if (content.includes('max') || content.includes('u64::max')) {
            findings.push({
              id: 'SOL243',
              severity: 'high',
              title: 'Trading Bot With Unlimited Approval',
              description: 'Bot has unlimited token approval. If bot is compromised, all approved tokens can be stolen.',
              location: `Function: ${fn.name}`,
              recommendation: 'Approve only amounts needed for specific trades. Revoke approvals after trading.',
            });
          }
        }
      }

      // Check for mempool transaction handling
      if (content.includes('mempool') || content.includes('pending') || content.includes('unconfirmed')) {
        findings.push({
          id: 'SOL243',
          severity: 'medium',
          title: 'Mempool Transaction Dependency',
          description: 'Code interacts with mempool/pending transactions. These can be manipulated or front-run.',
          location: `Function: ${fn.name}`,
          recommendation: 'Avoid dependencies on mempool state. Use private transaction relays when possible.',
        });
      }

      // Check for slippage in automated trades
      if (content.includes('auto') && (content.includes('swap') || content.includes('trade'))) {
        if (!content.includes('slippage') && !content.includes('min_out')) {
          findings.push({
            id: 'SOL243',
            severity: 'high',
            title: 'Automated Trade Without Slippage',
            description: 'Automated trading without slippage protection. Trades could execute at unfavorable prices.',
            location: `Function: ${fn.name}`,
            recommendation: 'Always set slippage limits for automated trades. Consider time-based slippage adjustments.',
          });
        }
      }

      // Check for user fund custody
      if (content.includes('deposit') || content.includes('custody') || content.includes('vault')) {
        if (content.includes('bot') || content.includes('auto')) {
          if (!content.includes('withdraw') || !content.includes('user')) {
            findings.push({
              id: 'SOL243',
              severity: 'high',
              title: 'Bot Custody Without User Withdrawal',
              description: 'Funds deposited for bot use may lack user-controlled withdrawal mechanism.',
              location: `Function: ${fn.name}`,
              recommendation: 'Ensure users can always withdraw their funds regardless of bot state.',
            });
          }
        }
      }

      // Check for private key in bot context
      if (content.includes('keypair') || content.includes('private_key') || content.includes('secret_key')) {
        if (content.includes('env') || content.includes('config') || content.includes('file')) {
          findings.push({
            id: 'SOL243',
            severity: 'critical',
            title: 'Bot Key Storage Risk',
            description: 'Trading bot stores private keys. Banana Gun was compromised through key exposure.',
            location: `Function: ${fn.name}`,
            recommendation: 'Use hardware security modules or secure enclaves. Never store keys in plaintext.',
          });
        }
      }

      // Check for MEV protection in bots
      if (content.includes('jito') || content.includes('bundle') || content.includes('tip')) {
        if (!content.includes('verify') && !content.includes('validate')) {
          findings.push({
            id: 'SOL243',
            severity: 'medium',
            title: 'MEV Bundle Without Verification',
            description: 'MEV bundles used without proper verification. Malicious bundles could include harmful transactions.',
            location: `Function: ${fn.name}`,
            recommendation: 'Verify all transactions in bundles. Validate bundle execution outcome before accepting.',
          });
        }
      }

      // Check for rate limiting in bot operations
      if ((content.includes('loop') || content.includes('while')) && 
          (content.includes('trade') || content.includes('snipe') || content.includes('buy'))) {
        if (!content.includes('rate_limit') && !content.includes('cooldown') && !content.includes('delay')) {
          findings.push({
            id: 'SOL243',
            severity: 'medium',
            title: 'Trading Bot Without Rate Limiting',
            description: 'Trading loop without rate limiting. Could lead to excessive fees or exploitation.',
            location: `Function: ${fn.name}`,
            recommendation: 'Implement rate limiting and cooldown periods between trades.',
          });
        }
      }

      // Check for error handling in automated trades
      if (content.includes('auto') && (content.includes('unwrap') || content.includes('expect'))) {
        findings.push({
          id: 'SOL243',
          severity: 'medium',
          title: 'Automated Trade With Panic on Error',
          description: 'Automated trading code can panic on errors. This could leave funds in unexpected states.',
          location: `Function: ${fn.name}`,
          recommendation: 'Use proper error handling (?) instead of unwrap/expect. Implement recovery mechanisms.',
        });
      }
    }
  }

  if (idl) {
    // Check for bot-related instructions
    for (const instruction of idl.instructions) {
      const name = instruction.name.toLowerCase();
      
      if (name.includes('bot') || name.includes('auto') || name.includes('snipe')) {
        // Check for user authority requirement
        const hasUserAuthority = instruction.accounts.some(acc => 
          acc.name.toLowerCase().includes('user') &&
          (acc.isSigner === true || acc.name.toLowerCase().includes('authority'))
        );

        if (!hasUserAuthority) {
          findings.push({
            id: 'SOL243',
            severity: 'high',
            title: 'Bot Instruction Without User Authority',
            description: `${instruction.name} doesn't require user signature. Unauthorized trades possible.`,
            location: `Instruction: ${instruction.name}`,
            recommendation: 'Require user signature or delegated authority for all trading operations.',
          });
        }
      }
    }
  }

  return findings;
}
