import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL201: Loan/Collateral Ratio Manipulation
 * 
 * Detects vulnerabilities in loan-to-collateral ratio calculations.
 * 
 * Real-world exploit: Loopscale - $5.8M stolen via collateral ratio manipulation.
 */
export function checkLoopscaleExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, path } = input;

  if (!rust) return findings;

  const patterns = [
    { pattern: /loan_to_value/i, desc: 'LTV calculation' },
    { pattern: /collateral_ratio/i, desc: 'Collateral ratio' },
    { pattern: /health_factor/i, desc: 'Health factor calculation' },
    { pattern: /borrow_limit/i, desc: 'Borrow limit' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of patterns) {
      if (pattern.test(line)) {
        const context = lines.slice(Math.max(0, i - 10), i + 10).join('\n');
        if (!context.includes('oracle') || !context.includes('twap')) {
          findings.push({
            id: 'SOL201',
            severity: 'high',
            title: 'Collateral Ratio Vulnerability',
            description: `${desc} - ensure oracle-backed and manipulation-resistant calculation.`,
            location: { file: path, line: i + 1 },
            recommendation: 'Use TWAP oracles for collateral valuation. Add manipulation detection.',
          });
        }
      }
    }
  }

  return findings;
}
