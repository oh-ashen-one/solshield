import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

export function checkClockExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const content = input.rust?.content || '';
  const fileName = input.rust?.filePath || 'unknown';

  // Check for clock/timestamp usage
  const clockPatterns = [
    /Clock::get/gi,
    /sysvar::clock/gi,
    /unix_timestamp/gi,
    /current_time/gi,
    /block_time/gi,
  ];

  for (const pattern of clockPatterns) {
    const matches = [...content.matchAll(pattern)];
    for (const match of matches) {
      const contextEnd = Math.min(content.length, match.index! + 1500);
      const functionContext = content.substring(match.index!, contextEnd);
      
      // Check for timestamp comparison safety
      if (functionContext.includes('>') || functionContext.includes('<')) {
        // Look for strict equality issues
        if (functionContext.includes('==') && functionContext.includes('timestamp')) {
          const lineNumber = content.substring(0, match.index).split('\n').length;
          findings.push({
            id: 'SOL173',
            title: 'Strict Timestamp Equality',
            severity: 'high',
            description: 'Timestamp compared with strict equality. Block times are not precise and may never match exactly.',
            location: { file: fileName, line: lineNumber },
            recommendation: 'Use range comparison instead of strict equality for timestamps.',
          });
        }
      }

      // Check for timestamp in randomness
      if (functionContext.includes('random') || functionContext.includes('seed')) {
        const lineNumber = content.substring(0, match.index).split('\n').length;
        findings.push({
          id: 'SOL173',
          title: 'Timestamp Used for Randomness',
          severity: 'critical',
          description: 'Timestamp used in randomness generation. Validators can manipulate block time slightly.',
          location: { file: fileName, line: lineNumber },
          recommendation: 'Use verifiable randomness (VRF) instead of timestamp for random values.',
        });
      }
    }
  }

  // Check for slot-based timing
  const slotPatterns = [
    /slot/gi,
    /current_slot/gi,
    /Slot/gi,
  ];

  for (const pattern of slotPatterns) {
    const matches = [...content.matchAll(pattern)];
    for (const match of matches) {
      const contextEnd = Math.min(content.length, match.index! + 1000);
      const functionContext = content.substring(match.index!, contextEnd);
      
      // Check for slot-based time assumptions
      if (functionContext.includes('400') || functionContext.includes('ms') ||
          functionContext.includes('millisecond')) {
        const lineNumber = content.substring(0, match.index).split('\n').length;
        findings.push({
          id: 'SOL173',
          title: 'Hardcoded Slot Duration',
          severity: 'medium',
          description: 'Slot duration appears hardcoded. Slot times vary and changed historically.',
          location: { file: fileName, line: lineNumber },
          recommendation: 'Use timestamp from Clock sysvar instead of calculating from slots.',
        });
      }
    }
  }

  // Check for expiry/deadline patterns
  const expiryPatterns = [
    /expiry|deadline|valid_until|expires/gi,
  ];

  for (const pattern of expiryPatterns) {
    const matches = [...content.matchAll(pattern)];
    for (const match of matches) {
      const contextEnd = Math.min(content.length, match.index! + 800);
      const functionContext = content.substring(match.index!, contextEnd);
      
      // Check for grace period
      if (!functionContext.includes('grace') && !functionContext.includes('buffer') &&
          !functionContext.includes('leeway')) {
        const lineNumber = content.substring(0, match.index).split('\n').length;
        findings.push({
          id: 'SOL173',
          title: 'Deadline Without Grace Period',
          severity: 'low',
          description: 'Deadline/expiry without grace period. Network delays could cause valid transactions to fail.',
          location: { file: fileName, line: lineNumber },
          recommendation: 'Consider small grace period (few seconds) for time-sensitive operations.',
        });
      }
    }
  }

  // Check for auction timing
  if (content.includes('auction') && content.includes('time')) {
    const auctionTimePatterns = [
      /auction_start/gi,
      /auction_end/gi,
      /bidding_period/gi,
    ];

    for (const pattern of auctionTimePatterns) {
      const matches = [...content.matchAll(pattern)];
      for (const match of matches) {
        const contextEnd = Math.min(content.length, match.index! + 1000);
        const functionContext = content.substring(match.index!, contextEnd);
        
        // Check for minimum duration
        if (!functionContext.includes('min_duration') && !functionContext.includes('minimum')) {
          const lineNumber = content.substring(0, match.index).split('\n').length;
          findings.push({
            id: 'SOL173',
            title: 'Auction Without Minimum Duration',
            severity: 'medium',
            description: 'Auction without minimum duration enforcement. Very short auctions may not allow fair participation.',
            location: { file: fileName, line: lineNumber },
            recommendation: 'Enforce minimum auction duration (e.g., 1 hour).',
          });
        }

        // Check for extension on late bids
        if (functionContext.includes('bid') && !functionContext.includes('extend') &&
            !functionContext.includes('extension')) {
          const lineNumber = content.substring(0, match.index).split('\n').length;
          findings.push({
            id: 'SOL173',
            title: 'Auction Without Anti-Snipe',
            severity: 'medium',
            description: 'Auction without time extension on late bids. Vulnerable to last-second sniping.',
            location: { file: fileName, line: lineNumber },
            recommendation: 'Extend auction by few minutes if bid placed near end time.',
          });
        }
      }
    }
  }

  // Check for vesting schedules
  if (content.includes('vest') || content.includes('unlock')) {
    const vestingPatterns = [
      /vesting_schedule/gi,
      /unlock_time/gi,
      /cliff/gi,
    ];

    for (const pattern of vestingPatterns) {
      const matches = [...content.matchAll(pattern)];
      for (const match of matches) {
        const contextEnd = Math.min(content.length, match.index! + 1000);
        const functionContext = content.substring(match.index!, contextEnd);
        
        // Check for multiple claims
        if (!functionContext.includes('claimed') && !functionContext.includes('withdrawn')) {
          const lineNumber = content.substring(0, match.index).split('\n').length;
          findings.push({
            id: 'SOL173',
            title: 'Vesting Without Claim Tracking',
            severity: 'high',
            description: 'Vesting schedule without tracking claimed amounts. May allow multiple claims.',
            location: { file: fileName, line: lineNumber },
            recommendation: 'Track total claimed amount and remaining vested balance.',
          });
        }
      }
    }
  }

  return findings;
}
