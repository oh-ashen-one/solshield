import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL211: AMM Pool Admin Key Security
 * 
 * Detects vulnerabilities in AMM admin key management.
 * 
 * Real-world exploit: Raydium - $4.4M stolen via compromised admin key.
 */
export function checkRaydiumExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, idl, path } = input;

  if (idl) {
    const adminInstructions = idl.instructions.filter(ix =>
      ix.name.toLowerCase().includes('admin') ||
      ix.name.toLowerCase().includes('withdraw_fee') ||
      ix.name.toLowerCase().includes('set_owner')
    );

    for (const ix of adminInstructions) {
      findings.push({
        id: 'SOL211',
        severity: 'high',
        title: 'AMM Admin Function',
        description: `Instruction "${ix.name}" has admin privileges - ensure key security.`,
        location: { file: path, line: 1 },
        recommendation: 'Use cold storage, multi-sig, and timelocks for admin keys.',
      });
    }
  }

  if (!rust) return findings;

  const patterns = [
    { pattern: /admin_key/i, desc: 'Admin key reference' },
    { pattern: /pool_admin/i, desc: 'Pool admin' },
    { pattern: /fee_owner/i, desc: 'Fee owner' },
    { pattern: /withdraw_protocol_fee/i, desc: 'Protocol fee withdrawal' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of patterns) {
      if (pattern.test(line)) {
        findings.push({
          id: 'SOL211',
          severity: 'high',
          title: 'AMM Admin Key Pattern',
          description: `${desc} - admin key compromise can drain protocol fees.`,
          location: { file: path, line: i + 1 },
          recommendation: 'Store admin keys in cold storage. Implement multi-sig.',
        });
      }
    }
  }

  return findings;
}
