import type { Finding } from '../commands/audit.js';
import type { ParsedRust } from '../parsers/rust.js';

/**
 * Gaming and NFT Exploit Patterns
 * 
 * Based on Aurory SyncSpace exploit and various NFT gaming vulnerabilities.
 * Covers in-game economies, NFT minting, reward systems, and game state manipulation.
 * 
 * Detects:
 * - Game state manipulation
 * - Reward system exploits
 * - NFT rarity manipulation
 * - In-game economy vulnerabilities
 */

export function checkGamingNftExploits(parsed: ParsedRust): Finding[] {
  const findings: Finding[] = [];
  const content = parsed.content;

  // Pattern 1: Game state without verification
  if (/game.*state|player.*state|session.*data/i.test(content)) {
    if (!/verify.*state|validate.*game|check.*integrity/i.test(content)) {
      findings.push({
        id: 'GAME_STATE_NOT_VERIFIED',
        severity: 'high',
        title: 'Game State Not Cryptographically Verified',
        description: 'Game state changes without cryptographic verification. Players could submit fake game results.',
        location: parsed.path,
        recommendation: 'Use signed game state or commit-reveal schemes. Verify game actions server-side or with ZK proofs.'
      });
    }
  }

  // Pattern 2: Client-side game logic trust
  if (/client.*side|frontend.*game|browser.*game/i.test(content) && /score|reward|win|result/i.test(content)) {
    if (!/server.*verify|backend.*validate|chain.*confirm/i.test(content)) {
      findings.push({
        id: 'CLIENT_SIDE_GAME_TRUST',
        severity: 'critical',
        title: 'Trusting Client-Side Game Logic',
        description: 'Game outcomes determined client-side. Players can modify client to always win/cheat.',
        location: parsed.path,
        recommendation: 'Never trust client-submitted game results. Use server-authoritative or ZK-proven game state.'
      });
    }
  }

  // Pattern 3: NFT rarity manipulation
  if (/rarity|trait|attribute|metadata/i.test(content) && /nft|mint|generate/i.test(content)) {
    if (!/commit.*reveal|vrf|randomness.*verified/i.test(content)) {
      findings.push({
        id: 'NFT_RARITY_PREDICTABLE',
        severity: 'high',
        title: 'NFT Rarity May Be Predictable',
        description: 'NFT trait generation without verifiable randomness. Attackers can predict or manipulate rare traits.',
        location: parsed.path,
        recommendation: 'Use VRF (Verifiable Random Function) for trait generation. Implement commit-reveal for fair minting.'
      });
    }
  }

  // Pattern 4: In-game currency inflation
  if (/in.*game.*currency|game.*token|reward.*token|play.*earn/i.test(content)) {
    if (!/supply.*cap|emission.*rate|max.*reward/i.test(content)) {
      findings.push({
        id: 'GAME_CURRENCY_INFLATION',
        severity: 'high',
        title: 'In-Game Currency Without Inflation Control',
        description: 'Game currency without emission controls. Exploits can lead to hyperinflation and economy collapse.',
        location: parsed.path,
        recommendation: 'Implement strict emission schedules. Add sinks to balance rewards. Cap daily/weekly emissions.'
      });
    }
  }

  // Pattern 5: Achievement/quest completion spoofing
  if (/achievement|quest|mission|task.*complete/i.test(content)) {
    if (!/proof.*of|verify.*complete|on.*chain.*record/i.test(content)) {
      findings.push({
        id: 'ACHIEVEMENT_SPOOFABLE',
        severity: 'medium',
        title: 'Achievement Completion May Be Spoofable',
        description: 'Quest/achievement completion without on-chain proof. Players could claim rewards without completing tasks.',
        location: parsed.path,
        recommendation: 'Record key game events on-chain. Use verifiable proofs for achievement completion.'
      });
    }
  }

  // Pattern 6: NFT staking reward manipulation
  if (/stake.*nft|nft.*stake|lock.*nft/i.test(content) && /reward|yield|earn/i.test(content)) {
    if (!/snapshot|time.*weight|duration.*check/i.test(content)) {
      findings.push({
        id: 'NFT_STAKING_FLASHABLE',
        severity: 'high',
        title: 'NFT Staking Rewards May Be Flashable',
        description: 'Staking rewards calculated without time-weighting. Flash stake attacks could claim disproportionate rewards.',
        location: parsed.path,
        recommendation: 'Use time-weighted staking calculations. Implement minimum stake duration. Add reward vesting.'
      });
    }
  }

  // Pattern 7: Syncspace/off-chain game state sync
  if (/sync|off.*chain.*state|game.*server|bridge.*state/i.test(content)) {
    if (!/signature.*verify|oracle.*attestation|merkle.*proof/i.test(content)) {
      findings.push({
        id: 'GAME_STATE_SYNC_INSECURE',
        severity: 'high',
        title: 'Off-Chain Game State Sync Not Secured',
        description: 'Game state synchronization without cryptographic proofs. Aurory SyncSpace style vulnerability.',
        location: parsed.path,
        recommendation: 'Use signed messages from game server. Verify signatures on-chain. Consider ZK proofs for game state.'
      });
    }
  }

  // Pattern 8: Item/loot box manipulation
  if (/loot.*box|item.*drop|random.*item|gacha/i.test(content)) {
    if (!/fair.*random|vrf|provably.*fair/i.test(content)) {
      findings.push({
        id: 'LOOTBOX_NOT_FAIR',
        severity: 'medium',
        title: 'Loot Box/Item Drop Not Provably Fair',
        description: 'Random item generation without provable fairness. Players may question legitimacy or game could cheat.',
        location: parsed.path,
        recommendation: 'Use VRF for item drops. Publish drop rates. Make randomness source verifiable.'
      });
    }
  }

  // Pattern 9: PvP result manipulation
  if (/pvp|player.*vs|battle|duel|match/i.test(content) && /result|winner|outcome/i.test(content)) {
    if (!/consensus|both.*sign|arbiter|dispute/i.test(content)) {
      findings.push({
        id: 'PVP_RESULT_SINGLE_REPORT',
        severity: 'high',
        title: 'PvP Results Reported by Single Party',
        description: 'PvP match results determined by single player submission. Losing player could dispute or winner could cheat.',
        location: parsed.path,
        recommendation: 'Require both players to sign match result. Use game server attestation. Add dispute resolution.'
      });
    }
  }

  // Pattern 10: NFT breeding/fusion exploits
  if (/breed|fusion|combine|merge.*nft/i.test(content)) {
    if (!/cooldown|breed.*limit|generation.*cap/i.test(content)) {
      findings.push({
        id: 'NFT_BREEDING_NO_LIMITS',
        severity: 'medium',
        title: 'NFT Breeding Without Rate Limits',
        description: 'NFT breeding/fusion without cooldowns or limits. Could lead to infinite NFT generation and economy collapse.',
        location: parsed.path,
        recommendation: 'Implement breeding cooldowns. Limit generations. Require resource burn for breeding.'
      });
    }
  }

  // Pattern 11: Tournament/leaderboard manipulation
  if (/tournament|leaderboard|ranking|competitive/i.test(content)) {
    if (!/anti.*cheat|verify.*score|submission.*proof/i.test(content)) {
      findings.push({
        id: 'TOURNAMENT_SCORE_MANIPULABLE',
        severity: 'high',
        title: 'Tournament Scores May Be Manipulable',
        description: 'Competitive scores without anti-cheat verification. Players could submit fake scores to win prizes.',
        location: parsed.path,
        recommendation: 'Implement robust score verification. Use replay validation. Add stake-based sybil resistance.'
      });
    }
  }

  return findings;
}
