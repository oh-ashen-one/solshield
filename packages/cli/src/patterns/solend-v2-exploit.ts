import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL212: Lending Market Configuration
 * 
 * Detects vulnerabilities in lending market configuration.
 * 
 * Real-world vulnerability: Solend Protocol (Nov 2022)
 */
export function checkSolendV2Exploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, path } = input;

  if (!rust) return findings;

  const patterns = [
    { pattern: /reserve_config/i, desc: 'Reserve configuration' },
    { pattern: /lending_market/i, desc: 'Lending market' },
    { pattern: /interest_rate/i, desc: 'Interest rate' },
    { pattern: /utilization_rate/i, desc: 'Utilization rate' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of patterns) {
      if (pattern.test(line)) {
        const context = lines.slice(i, i + 15).join('\n');
        if (!context.includes('validate') && !context.includes('bounds')) {
          findings.push({
            id: 'SOL212',
            severity: 'high',
            title: 'Lending Config Without Bounds',
            description: `${desc} - configuration should have validation bounds.`,
            location: { file: path, line: i + 1 },
            recommendation: 'Add minimum/maximum bounds for all lending parameters.',
          });
        }
      }
    }
  }

  return findings;
}
