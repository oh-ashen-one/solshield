import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL178: Bonding Curve Price Manipulation
 * 
 * Detects vulnerable bonding curve implementations that can be
 * manipulated via flash loans or large purchases.
 * 
 * Real-world exploit: Nirvana Finance - $3.5M stolen via bonding
 * curve manipulation using flash loans.
 */
export function checkBondingCurveExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, idl, path } = input;

  // Check IDL for bonding curve instructions
  if (idl) {
    const bondingInstructions = idl.instructions.filter(ix => 
      ix.name.toLowerCase().includes('bond') ||
      ix.name.toLowerCase().includes('curve') ||
      ix.name.toLowerCase().includes('mint') && ix.name.toLowerCase().includes('price')
    );

    for (const ix of bondingInstructions) {
      // Check for flash loan protection
      const hasFlashProtection = ix.accounts?.some(acc =>
        acc.name.toLowerCase().includes('flash') ||
        acc.name.toLowerCase().includes('lock') ||
        acc.name.toLowerCase().includes('cooldown')
      );

      if (!hasFlashProtection) {
        findings.push({
          id: 'SOL178',
          severity: 'critical',
          title: 'Bonding Curve Without Flash Loan Protection',
          description: `Instruction "${ix.name}" appears to implement bonding curve logic without flash loan protection. Attackers can manipulate price within a single transaction.`,
          location: { file: path, line: 1 },
          recommendation: 'Implement same-slot protection, price impact limits, and cooldown periods for large trades.',
        });
      }
    }
  }

  if (!rust) return findings;

  const dangerousPatterns = [
    /bonding_curve.*price/i,
    /price_per_token/i,
    /calculate_price.*supply/i,
    /mint.*amount.*price/i,
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const pattern of dangerousPatterns) {
      if (pattern.test(line)) {
        const context = lines.slice(i, i + 20).join('\n');
        // Check for price manipulation protections
        if (!context.includes('max_price_impact') && 
            !context.includes('slippage') &&
            !context.includes('cooldown') &&
            !context.includes('same_slot')) {
          findings.push({
            id: 'SOL178',
            severity: 'high',
            title: 'Bonding Curve Manipulation Risk',
            description: 'Bonding curve calculation found without apparent price impact limits or manipulation protection.',
            location: { file: path, line: i + 1 },
            recommendation: 'Add maximum price impact checks, slippage protection, and same-slot purchase limits.',
          });
          break;
        }
      }
    }
  }

  return findings;
}
