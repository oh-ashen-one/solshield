import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL200: Internal System Compromise
 * 
 * Detects patterns that could indicate vulnerability to internal
 * system compromise attacks.
 * 
 * Real-world exploit: NoOnes Platform - internal system compromise
 * led to fund theft.
 */
export function checkNoonesExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, path } = input;

  if (!rust) return findings;

  const riskPatterns = [
    { pattern: /admin.*backdoor/i, desc: 'Admin backdoor' },
    { pattern: /debug.*production/i, desc: 'Debug code in production' },
    { pattern: /test.*key.*mainnet/i, desc: 'Test keys on mainnet' },
    { pattern: /hardcoded.*secret/i, desc: 'Hardcoded secrets' },
    { pattern: /env\[.*password/i, desc: 'Password in environment' },
    { pattern: /internal.*api.*public/i, desc: 'Internal API exposure' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of riskPatterns) {
      if (pattern.test(line)) {
        findings.push({
          id: 'SOL200',
          severity: 'critical',
          title: 'Internal System Security Risk',
          description: `${desc} - could lead to internal system compromise.`,
          location: { file: path, line: i + 1 },
          recommendation: 'Remove debug code, use proper secret management, and audit internal systems.',
        });
      }
    }
  }

  return findings;
}
