import { VulnerabilityPattern } from '../types';

/**
 * Batch 52: Real-World Exploit Signatures
 * SOL7376-SOL7425 (50 patterns)
 * Based on actual Solana mainnet exploits and post-mortems
 */
export const realExploitPatterns: VulnerabilityPattern[] = [
  // Wormhole-Style Exploits ($326M - Feb 2022)
  {
    id: 'SOL7376',
    name: 'Guardian Signature Bypass',
    description: 'Signature verification bypassable through deprecated syscall (Wormhole-style)',
    severity: 'critical',
    category: 'bridge',
    pattern: /verify.*signature.*deprecated|sol_verify_signatures|secp256k1.*verify/gi,
    recommendation: 'Use current signature verification methods and validate all guardian signatures'
  },
  {
    id: 'SOL7377',
    name: 'VAA Validation Skip',
    description: 'Verified Action Approval validation can be skipped',
    severity: 'critical',
    category: 'bridge',
    pattern: /vaa.*verify|guardian.*set.*validate|message.*attestation/gi,
    recommendation: 'Ensure all VAAs are fully validated before processing'
  },
  {
    id: 'SOL7378',
    name: 'Sysvar Spoofing',
    description: 'System variable account can be spoofed with fake data',
    severity: 'critical',
    category: 'core',
    pattern: /sysvar.*account(?!.*check.*key)|instructions.*sysvar(?!.*verify)/gi,
    recommendation: 'Validate sysvar account addresses against known system addresses'
  },

  // Mango Markets Exploit ($116M - Oct 2022)
  {
    id: 'SOL7379',
    name: 'Oracle Price Manipulation',
    description: 'Oracle price manipulable through low-liquidity market (Mango-style)',
    severity: 'critical',
    category: 'defi',
    pattern: /oracle.*price.*direct|spot.*price.*borrow|collateral.*oracle/gi,
    recommendation: 'Use TWAP oracles and implement price deviation circuit breakers'
  },
  {
    id: 'SOL7380',
    name: 'Self-Referential Collateral',
    description: 'Collateral value depends on manipulable asset price',
    severity: 'critical',
    category: 'defi',
    pattern: /collateral.*same.*token|self.*collateralize|circular.*borrow/gi,
    recommendation: 'Prevent using borrowed assets as collateral in same position'
  },
  {
    id: 'SOL7381',
    name: 'Perp Funding Extraction',
    description: 'Perpetual funding rate extractable through position manipulation',
    severity: 'high',
    category: 'defi',
    pattern: /funding.*extract|perp.*position.*large|mark.*manipulation/gi,
    recommendation: 'Implement position limits and funding rate caps'
  },

  // Cashio Exploit ($52M - Mar 2022)
  {
    id: 'SOL7382',
    name: 'Infinite Mint Vulnerability',
    description: 'Token can be minted infinitely through validation bypass (Cashio-style)',
    severity: 'critical',
    category: 'token',
    pattern: /mint.*without.*collateral|mint.*bypass|uncollateralized.*mint/gi,
    recommendation: 'Verify collateral backing before any mint operation'
  },
  {
    id: 'SOL7383',
    name: 'Collateral Validation Skip',
    description: 'Collateral account validation can be skipped',
    severity: 'critical',
    category: 'defi',
    pattern: /collateral.*skip|backing.*unverified|reserve.*check.*missing/gi,
    recommendation: 'Always validate collateral accounts and their balances'
  },
  {
    id: 'SOL7384',
    name: 'Nested Account Confusion',
    description: 'Nested account structure allows validation bypass',
    severity: 'critical',
    category: 'core',
    pattern: /nested.*account|account.*of.*account|indirect.*validation/gi,
    recommendation: 'Validate entire account chain, not just direct references'
  },

  // Crema Finance Exploit ($8.8M - Jul 2022)
  {
    id: 'SOL7385',
    name: 'Flash Loan Price Manipulation',
    description: 'Flash loan enables price manipulation for profit (Crema-style)',
    severity: 'critical',
    category: 'defi',
    pattern: /flash.*loan.*price|borrow.*manipulate|same.*block.*price/gi,
    recommendation: 'Use TWAP and implement flash loan guards on price-sensitive operations'
  },
  {
    id: 'SOL7386',
    name: 'Tick Liquidity Drain',
    description: 'Concentrated liquidity ticks drainable through price manipulation',
    severity: 'critical',
    category: 'defi',
    pattern: /tick.*drain|liquidity.*extract|concentrated.*exploit/gi,
    recommendation: 'Implement tick-level protections and manipulation detection'
  },
  {
    id: 'SOL7387',
    name: 'Fee Accounting Mismatch',
    description: 'Fee calculation differs from actual token movements',
    severity: 'high',
    category: 'defi',
    pattern: /fee.*mismatch|accounting.*error|fee.*calculation.*wrong/gi,
    recommendation: 'Ensure fee accounting matches actual token transfers'
  },

  // Solend Oracle Manipulation ($2M - Nov 2022)
  {
    id: 'SOL7388',
    name: 'Single Oracle Dependency',
    description: 'Protocol relies on single oracle source (Solend-style)',
    severity: 'critical',
    category: 'defi',
    pattern: /single.*oracle|one.*price.*source|oracle(?!.*aggregate)/gi,
    recommendation: 'Use multiple oracle sources with median/aggregate pricing'
  },
  {
    id: 'SOL7389',
    name: 'Stale Oracle Price',
    description: 'Oracle price not checked for staleness',
    severity: 'high',
    category: 'defi',
    pattern: /oracle.*price(?!.*stale)|price.*feed(?!.*timestamp)|get.*price(?!.*age)/gi,
    recommendation: 'Check oracle price timestamp and reject stale data'
  },
  {
    id: 'SOL7390',
    name: 'Liquidation Cascade',
    description: 'Single liquidation can trigger cascade of liquidations',
    severity: 'high',
    category: 'defi',
    pattern: /liquidation.*chain|cascade.*liquidate|mass.*liquidation/gi,
    recommendation: 'Implement circuit breakers and gradual liquidation'
  },

  // Nirvana Finance Exploit ($3.5M - Jul 2022)
  {
    id: 'SOL7391',
    name: 'Flash Loan Collateral Attack',
    description: 'Flash loan used to inflate collateral temporarily',
    severity: 'critical',
    category: 'defi',
    pattern: /flash.*collateral|temp.*inflate|borrow.*collateral.*same/gi,
    recommendation: 'Check collateral state before and after flash loan context'
  },
  {
    id: 'SOL7392',
    name: 'Algorithmic Stablecoin Depeg',
    description: 'Algorithmic mechanism exploitable for depeg profit',
    severity: 'critical',
    category: 'defi',
    pattern: /algorithmic.*stable|peg.*mechanism|rebase.*stable/gi,
    recommendation: 'Implement robust peg defense mechanisms'
  },
  {
    id: 'SOL7393',
    name: 'Swap Output Manipulation',
    description: 'Swap output amount manipulable through pool state',
    severity: 'high',
    category: 'defi',
    pattern: /swap.*output.*calculate|amount.*out.*pool|exchange.*rate.*spot/gi,
    recommendation: 'Use manipulation-resistant price calculations'
  },

  // Slope Wallet Exploit (Aug 2022)
  {
    id: 'SOL7394',
    name: 'Private Key Logging',
    description: 'Private key or seed phrase logged to external service',
    severity: 'critical',
    category: 'wallet',
    pattern: /log.*private.*key|send.*seed.*phrase|transmit.*secret/gi,
    recommendation: 'Never log or transmit private keys or seed phrases'
  },
  {
    id: 'SOL7395',
    name: 'Unencrypted Key Storage',
    description: 'Private keys stored without encryption',
    severity: 'critical',
    category: 'wallet',
    pattern: /store.*key.*plain|unencrypted.*secret|key.*localstorage/gi,
    recommendation: 'Always encrypt private keys at rest'
  },
  {
    id: 'SOL7396',
    name: 'Third-Party Key Exposure',
    description: 'Keys exposed to third-party analytics or logging',
    severity: 'critical',
    category: 'wallet',
    pattern: /analytics.*key|third.*party.*secret|external.*service.*key/gi,
    recommendation: 'Never send sensitive data to external services'
  },

  // Raydium Exploit ($4.4M - Dec 2022)
  {
    id: 'SOL7397',
    name: 'Admin Key Compromise',
    description: 'Protocol admin key allows unauthorized actions',
    severity: 'critical',
    category: 'governance',
    pattern: /admin.*key.*single|owner.*authority|centralized.*control/gi,
    recommendation: 'Use multisig and timelocks for admin operations'
  },
  {
    id: 'SOL7398',
    name: 'Pool Authority Bypass',
    description: 'Pool authority checks bypassable',
    severity: 'critical',
    category: 'defi',
    pattern: /pool.*authority(?!.*verify)|amm.*admin(?!.*check)/gi,
    recommendation: 'Verify pool authority on all privileged operations'
  },
  {
    id: 'SOL7399',
    name: 'Fee Withdrawal Attack',
    description: 'Protocol fees withdrawable by unauthorized party',
    severity: 'critical',
    category: 'defi',
    pattern: /fee.*withdraw(?!.*authority)|collect.*fee(?!.*check)/gi,
    recommendation: 'Verify authority on all fee collection operations'
  },

  // Saber Wrapped Token Issues
  {
    id: 'SOL7400',
    name: 'Wrapped Token Ratio Manipulation',
    description: 'Wrapped token exchange ratio manipulable',
    severity: 'high',
    category: 'token',
    pattern: /wrap.*ratio|exchange.*rate.*wrapped|peg.*wrapped/gi,
    recommendation: 'Ensure wrapped token ratios are manipulation-resistant'
  },
  {
    id: 'SOL7401',
    name: 'Decimal Mismatch Exploit',
    description: 'Token decimal mismatch allows value extraction',
    severity: 'high',
    category: 'token',
    pattern: /decimal.*mismatch|precision.*difference|token.*decimals.*vary/gi,
    recommendation: 'Normalize all token amounts to consistent precision'
  },
  {
    id: 'SOL7402',
    name: 'LP Token Share Dilution',
    description: 'LP token shares dilutable through deposit manipulation',
    severity: 'high',
    category: 'defi',
    pattern: /lp.*dilution|share.*manipulation|pool.*share.*extract/gi,
    recommendation: 'Protect against first-depositor and share manipulation attacks'
  },

  // Tulip Protocol Issues
  {
    id: 'SOL7403',
    name: 'Vault Share Inflation',
    description: 'Vault shares inflatable through donation attack',
    severity: 'high',
    category: 'defi',
    pattern: /vault.*share.*inflate|donation.*attack|share.*value.*manipulate/gi,
    recommendation: 'Initialize vaults with dead shares or minimum deposits'
  },
  {
    id: 'SOL7404',
    name: 'Strategy Migration Risk',
    description: 'Strategy migration can strand user funds',
    severity: 'high',
    category: 'defi',
    pattern: /strategy.*migrate|vault.*upgrade|fund.*transfer.*strategy/gi,
    recommendation: 'Ensure atomic strategy migrations with fund safety'
  },
  {
    id: 'SOL7405',
    name: 'Yield Source Manipulation',
    description: 'Yield source reporting manipulable for extraction',
    severity: 'high',
    category: 'defi',
    pattern: /yield.*source|apy.*calculate|return.*compute/gi,
    recommendation: 'Validate yield sources and implement sanity checks'
  },

  // Generic DeFi Attack Patterns
  {
    id: 'SOL7406',
    name: 'Read-Only Reentrancy',
    description: 'View function returns stale data during callback',
    severity: 'high',
    category: 'defi',
    pattern: /view.*during.*cpi|read.*state.*callback|get.*balance.*invoke/gi,
    recommendation: 'Use reentrancy guards even for read-only operations'
  },
  {
    id: 'SOL7407',
    name: 'Cross-Function Reentrancy',
    description: 'Reentrancy through different function than callback',
    severity: 'high',
    category: 'defi',
    pattern: /reentrant.*other.*function|cross.*function.*call/gi,
    recommendation: 'Implement global reentrancy guards across all functions'
  },
  {
    id: 'SOL7408',
    name: 'Governance Token Flash Loan',
    description: 'Governance token borrowable for vote manipulation',
    severity: 'critical',
    category: 'governance',
    pattern: /flash.*loan.*vote|borrow.*governance|token.*vote.*same.*block/gi,
    recommendation: 'Use voting escrow with lock periods'
  },
  {
    id: 'SOL7409',
    name: 'Price Feed Sandwich',
    description: 'Price update sandwichable for profit',
    severity: 'high',
    category: 'defi',
    pattern: /price.*update.*public|oracle.*push|feed.*update.*front/gi,
    recommendation: 'Use commit-reveal for price updates'
  },
  {
    id: 'SOL7410',
    name: 'Liquidity Provider Extraction',
    description: 'LP value extractable through impermanent loss manipulation',
    severity: 'high',
    category: 'defi',
    pattern: /lp.*extract|impermanent.*loss.*force|liquidity.*drain/gi,
    recommendation: 'Implement LP protection mechanisms'
  },

  // Program Upgrade Vulnerabilities
  {
    id: 'SOL7411',
    name: 'Upgrade Authority Single Point',
    description: 'Program upgrade controlled by single key',
    severity: 'high',
    category: 'governance',
    pattern: /upgrade.*authority.*single|program.*upgrade.*owner/gi,
    recommendation: 'Use multisig for program upgrade authority'
  },
  {
    id: 'SOL7412',
    name: 'Malicious Upgrade',
    description: 'Program can be upgraded to malicious version',
    severity: 'critical',
    category: 'governance',
    pattern: /upgrade.*no.*timelock|instant.*upgrade|upgrade(?!.*delay)/gi,
    recommendation: 'Implement upgrade timelocks and verification'
  },
  {
    id: 'SOL7413',
    name: 'Upgrade Data Migration',
    description: 'Program upgrade doesnt properly migrate data',
    severity: 'high',
    category: 'governance',
    pattern: /upgrade.*data.*loss|migration.*incomplete|version.*mismatch/gi,
    recommendation: 'Ensure data compatibility across upgrades'
  },

  // Account State Attacks
  {
    id: 'SOL7414',
    name: 'Uninitialized Account Usage',
    description: 'Uninitialized account used as if initialized',
    severity: 'critical',
    category: 'core',
    pattern: /account(?!.*initialized.*check)|use(?!.*init.*verify)|access.*uninit/gi,
    recommendation: 'Check account initialization before any operation'
  },
  {
    id: 'SOL7415',
    name: 'Account State Race',
    description: 'Account state raceable between check and use',
    severity: 'high',
    category: 'core',
    pattern: /check.*then.*use|state.*between|race.*condition.*account/gi,
    recommendation: 'Ensure atomic check-and-modify operations'
  },
  {
    id: 'SOL7416',
    name: 'Phantom Account Attack',
    description: 'Account appears valid but contains malicious data',
    severity: 'high',
    category: 'core',
    pattern: /account.*looks.*valid|fake.*account|spoofed.*state/gi,
    recommendation: 'Validate account data integrity comprehensively'
  },

  // Token-Specific Exploits
  {
    id: 'SOL7417',
    name: 'Token Burn Authority Abuse',
    description: 'Burn authority allows unauthorized token destruction',
    severity: 'high',
    category: 'token',
    pattern: /burn.*authority.*abuse|unauthorized.*burn|freeze.*then.*burn/gi,
    recommendation: 'Limit and audit burn authority usage'
  },
  {
    id: 'SOL7418',
    name: 'Token-2022 Hook Exploit',
    description: 'Transfer hook executes malicious code',
    severity: 'critical',
    category: 'token',
    pattern: /transfer.*hook.*malicious|hook.*arbitrary.*code|extension.*exploit/gi,
    recommendation: 'Audit and validate all token extensions'
  },
  {
    id: 'SOL7419',
    name: 'Metadata Injection',
    description: 'Token metadata contains malicious content',
    severity: 'medium',
    category: 'nft',
    pattern: /metadata.*inject|uri.*malicious|offchain.*exploit/gi,
    recommendation: 'Validate and sanitize all metadata content'
  },

  // Cross-Program Exploits
  {
    id: 'SOL7420',
    name: 'CPI Program Swap',
    description: 'Expected program swapped with malicious one in CPI',
    severity: 'critical',
    category: 'cpi',
    pattern: /program.*id.*user.*input|cpi.*target.*variable|invoke.*unchecked.*program/gi,
    recommendation: 'Hardcode or verify program IDs for all CPIs'
  },
  {
    id: 'SOL7421',
    name: 'CPI Account Injection',
    description: 'Attacker injects malicious accounts into CPI',
    severity: 'critical',
    category: 'cpi',
    pattern: /remaining.*accounts.*cpi|extra.*account.*inject|cpi.*account.*unchecked/gi,
    recommendation: 'Validate all accounts passed to CPI'
  },
  {
    id: 'SOL7422',
    name: 'Return Data Manipulation',
    description: 'CPI return data manipulated by malicious program',
    severity: 'high',
    category: 'cpi',
    pattern: /return.*data.*trust|cpi.*result.*unverified|get_return_data/gi,
    recommendation: 'Verify CPI return data against expected format'
  },

  // Economic Exploits
  {
    id: 'SOL7423',
    name: 'Fee Token Arbitrage',
    description: 'Protocol fee token arbitrageable for profit',
    severity: 'medium',
    category: 'defi',
    pattern: /fee.*token.*swap|protocol.*fee.*extract|fee.*arbitrage/gi,
    recommendation: 'Design fee mechanisms resistant to arbitrage'
  },
  {
    id: 'SOL7424',
    name: 'Reward Distribution Exploit',
    description: 'Reward distribution gaming for excess rewards',
    severity: 'high',
    category: 'defi',
    pattern: /reward.*distribution.*game|stake.*reward.*extract|emission.*exploit/gi,
    recommendation: 'Use time-weighted reward calculations'
  },
  {
    id: 'SOL7425',
    name: 'Economic Model Collapse',
    description: 'Economic model has collapse conditions',
    severity: 'high',
    category: 'defi',
    pattern: /death.*spiral|economic.*collapse|ponzi.*condition/gi,
    recommendation: 'Stress test economic models for extreme conditions'
  }
];

export default realExploitPatterns;
