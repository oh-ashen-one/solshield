import type { Finding } from '../commands/audit.js';
import type { PatternInput } from './index.js';

/**
 * SOL208: Token Contract Vulnerability
 * 
 * Detects common token contract vulnerabilities.
 * 
 * Real-world exploit: SVT Token - malicious token contract.
 */
export function checkSvtTokenExploit(input: PatternInput): Finding[] {
  const findings: Finding[] = [];
  const { rust, idl, path } = input;

  if (idl) {
    const tokenInstructions = idl.instructions.filter(ix =>
      ix.name.toLowerCase().includes('transfer') ||
      ix.name.toLowerCase().includes('mint') ||
      ix.name.toLowerCase().includes('burn')
    );

    for (const ix of tokenInstructions) {
      // Check for hidden fees or restrictions
      const hasHiddenAccounts = ix.accounts?.some(acc =>
        acc.name.toLowerCase().includes('fee') ||
        acc.name.toLowerCase().includes('tax')
      );

      if (hasHiddenAccounts) {
        findings.push({
          id: 'SOL208',
          severity: 'high',
          title: 'Token with Hidden Fees',
          description: `Instruction "${ix.name}" has fee/tax accounts - verify transparency.`,
          location: { file: path, line: 1 },
          recommendation: 'Clearly document all fees. Avoid hidden transfer restrictions.',
        });
      }
    }
  }

  if (!rust) return findings;

  const maliciousPatterns = [
    { pattern: /hidden.*fee/i, desc: 'Hidden fee' },
    { pattern: /transfer.*tax/i, desc: 'Transfer tax' },
    { pattern: /blacklist.*transfer/i, desc: 'Transfer blacklist' },
    { pattern: /whitelist.*only/i, desc: 'Whitelist restriction' },
    { pattern: /pause.*all/i, desc: 'Global pause' },
  ];

  const lines = rust.content.split('\n');
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    for (const { pattern, desc } of maliciousPatterns) {
      if (pattern.test(line)) {
        findings.push({
          id: 'SOL208',
          severity: 'high',
          title: 'Token Restriction Pattern',
          description: `${desc} - could be used for malicious purposes.`,
          location: { file: path, line: i + 1 },
          recommendation: 'Ensure all restrictions are clearly documented and have legitimate purposes.',
        });
      }
    }
  }

  return findings;
}
